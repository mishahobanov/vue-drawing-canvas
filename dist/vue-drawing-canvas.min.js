var VueDrawingCanvas=function(t){"use strict";function e(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function r(t){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?e(Object(i),!0).forEach((function(e){s(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function i(t,e,r,i,n,s,a){try{var o=t[s](a),h=o.value}catch(t){return void r(t)}o.done?e(h):Promise.resolve(h).then(i,n)}function n(t){return function(){var e=this,r=arguments;return new Promise((function(n,s){var a=t.apply(e,r);function o(t){i(a,n,s,o,h,"next",t)}function h(t){i(a,n,s,o,h,"throw",t)}o(void 0)}))}}function s(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}return t.defineComponent({name:"VueDrawingCanvas",props:{strokeType:{type:String,validator:function(t){return-1!==["dash","square","circle","triangle","half_triangle"].indexOf(t)},default:function(){return"dash"}},fillShape:{type:Boolean,default:function(){return!1}},width:{type:[String,Number],default:function(){return 600}},height:{type:[String,Number],default:function(){return 400}},image:{type:String,default:function(){return""}},eraser:{type:Boolean,default:function(){return!1}},color:{type:String,default:function(){return"#000000"}},lineWidth:{type:Number,default:function(){return 5}},lock:{type:Boolean,default:function(){return!1}},styles:{type:[Array,String,Object]},classes:{type:[Array,String,Object]},backgroundColor:{type:String,default:function(){return"#FFFFFF"}},backgroundImage:{type:String,default:function(){return null}},watermark:{type:Object},saveAs:{type:String,validator:function(t){return-1!==["jpeg","png"].indexOf(t)},default:function(){return"png"}},canvasId:{type:String,default:function(){return"VueDrawingCanvas"}},initialImage:{type:Array,default:function(){return[]}}},data:function(){return{loadedImage:null,drawing:!1,context:null,images:[],strokes:{type:"",from:{x:0,y:0},coordinates:[],color:"",width:"",fill:!1},guides:[],trash:[]}},mounted:function(){var t=this;this.setContext(),this.$nextTick((function(){t.drawInitialImage()}))},watch:{backgroundImage:function(){this.loadedImage=null}},methods:{setContext:function(){var t=this;return n(regeneratorRuntime.mark((function e(){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=document.querySelector("#"+t.canvasId),t.context=t.context?t.context:r.getContext("2d"),e.next=4,t.setBackground();case 4:case"end":return e.stop()}}),e)})))()},drawInitialImage:function(){this.initialImage.length>0&&(this.images=[].concat(this.images,this.initialImage),this.redraw())},clear:function(){this.context.clearRect(0,0,this.width,this.height)},setBackground:function(){var t=this;return n(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.clear(),t.context.fillStyle=t.backgroundColor,t.context.fillRect(0,0,t.width,t.height),e.next=5,t.$nextTick(n(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.drawBackgroundImage();case 2:case"end":return e.stop()}}),e)}))));case 5:t.save();case 6:case"end":return e.stop()}}),e)})))()},drawBackgroundImage:function(){var t=this;return n(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.loadedImage){e.next=4;break}return e.abrupt("return",new Promise((function(e){if(t.backgroundImage){var r=new Image;r.src=t.backgroundImage,r.onload=function(){t.context.drawImage(r,0,0,t.width,t.height),t.loadedImage=r,e()}}else e()})));case 4:t.context.drawImage(t.loadedImage,0,0,t.width,t.height);case 5:case"end":return e.stop()}}),e)})))()},getCoordinates:function(t){var e,r;if(t.touches&&t.touches.length>0){var i=document.querySelector("#"+this.canvasId).getBoundingClientRect();e=t.touches[0].clientX-i.left,r=t.touches[0].clientY-i.top}else e=t.offsetX,r=t.offsetY;return{x:e,y:r}},startDraw:function(t){if(!this.lock){this.drawing=!0;var e=this.getCoordinates(t);this.strokes={type:this.eraser?"eraser":this.strokeType,from:e,coordinates:[],color:this.eraser?this.backgroundColor:this.color,width:this.lineWidth,fill:!this.eraser&&"dash"!==this.strokeType&&this.fillShape},this.guides=[]}},draw:function(t){if(this.drawing){this.context||this.setContext();var e=this.getCoordinates(t);if(this.eraser||"dash"===this.strokeType)this.strokes.coordinates.push(e),this.drawShape(this.strokes,!1);else{var r;switch(this.strokeType){case"square":r=[{x:e.x,y:this.strokes.from.y},{x:e.x,y:e.y},{x:this.strokes.from.x,y:e.y},{x:this.strokes.from.x,y:this.strokes.from.y}];break;case"triangle":var i=Math.floor((e.x-this.strokes.from.x)/2)<0?-1*Math.floor((e.x-this.strokes.from.x)/2):Math.floor((e.x-this.strokes.from.x)/2),n=this.strokes.from.x<e.x?this.strokes.from.x+i:this.strokes.from.x-i;r=[{x:e.x,y:this.strokes.from.y},{x:n,y:e.y},{x:this.strokes.from.x,y:this.strokes.from.y}];break;case"half_triangle":r=[{x:e.x,y:this.strokes.from.y},{x:this.strokes.from.x,y:e.y},{x:this.strokes.from.x,y:this.strokes.from.y}];break;case"circle":var s=this.strokes.from.x-e.x<0?-1*(this.strokes.from.x-e.x):this.strokes.from.x-e.x;r=[{x:this.strokes.from.x>e.x?this.strokes.from.x-s:this.strokes.from.x+s,y:this.strokes.from.y},{x:s,y:s}]}this.guides=r,this.drawGuide(!0)}}},drawGuide:function(t){var e=this;this.redraw(!1),this.context.strokeStyle="#000000",this.context.lineWidth=1,this.context.lineJoin="round",this.context.lineCap="round",this.context.beginPath(),this.context.setLineDash([15,15]),"circle"===this.strokes.type?this.context.ellipse(this.guides[0].x,this.guides[0].y,this.guides[1].x,this.guides[1].y,0,0,2*Math.PI):(this.context.moveTo(this.strokes.from.x,this.strokes.from.y),this.guides.forEach((function(t){e.context.lineTo(t.x,t.y)})),t&&this.context.closePath()),this.context.stroke()},drawShape:function(t,e){var r=this;this.context.strokeStyle=t.color,this.context.fillStyle=t.color,this.context.lineWidth=t.width,this.context.lineJoin="round",this.context.lineCap="round",this.context.beginPath(),this.context.setLineDash([]),"circle"===t.type?this.context.ellipse(t.coordinates[0].x,t.coordinates[0].y,t.coordinates[1].x,t.coordinates[1].y,0,0,2*Math.PI):(this.context.moveTo(t.from.x,t.from.y),t.coordinates.forEach((function(t){r.context.lineTo(t.x,t.y)})),e&&this.context.closePath()),t.fill?this.context.fill():this.context.stroke()},stopDraw:function(){this.drawing&&(this.strokes.coordinates=this.guides.length>0?this.guides:this.strokes.coordinates,this.images.push(this.strokes),this.redraw(),this.drawing=!1,this.trash=[])},reset:function(){this.lock||(this.images=[],this.strokes={type:"",coordinates:[],color:"",width:"",fill:!1},this.guides=[],this.trash=[],this.redraw())},undo:function(){if(!this.lock){var t=this.images.pop();t&&(this.trash.push(t),this.redraw())}},redo:function(){if(!this.lock){var t=this.trash.pop();t&&(this.images.push(t),this.redraw())}},redraw:function(t){var e=this;return n(regeneratorRuntime.mark((function r(){return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return t=void 0===t||t,r.next=3,e.setBackground().then((function(){e.images.forEach((function(t){e.drawShape(t,e.type=!1)}))})).then((function(){t&&e.save()}));case 3:case"end":return r.stop()}}),r)})))()},wrapText:function(t,e,r,i,n,s){for(var a=/\s+/g,o=e.split(/(\r\n|\n\r|\n|\r)+/g).filter((function(t){return t.length>0})),h=0;h<o.length;h++){for(var c=o[h].split(a).filter((function(t){return t.length>0})),u="",l=0;l<c.length;l++){var f=u+c[l]+" ";t.measureText(f).width>n&&l>0?(this.watermark.fontStyle&&this.watermark.fontStyle.drawType&&"stroke"===this.watermark.fontStyle.drawType?t.strokeText(u,r,i):t.fillText(u,r,i),u=c[l]+" ",i+=s):u=f}this.watermark.fontStyle&&this.watermark.fontStyle.drawType&&"stroke"===this.watermark.fontStyle.drawType?t.strokeText(u,r,i):t.fillText(u,r,i),i+=c.length>0?s:0}},save:function(){var t=this;if(!this.watermark){var e=document.querySelector("#"+this.canvasId);return this.$emit("update:image",e.toDataURL("image/"+this.saveAs,1)),e.toDataURL("image/"+this.saveAs,1)}var r=document.querySelector("#"+this.canvasId),i=document.createElement("canvas"),n=i.getContext("2d");if(i.width=this.width,i.height=this.height,n.drawImage(r,0,0,this.width,this.height),"Image"===this.watermark.type){var s=this.watermark.imageStyle&&this.watermark.imageStyle.width?this.watermark.imageStyle.width:this.width,a=this.watermark.imageStyle&&this.watermark.imageStyle.height?this.watermark.imageStyle.height:this.height,o=new Image;o.src=this.watermark.source,o.onload=function(){return n.drawImage(o,t.watermark.x,t.watermark.y,s,a),t.$emit("update:image",i.toDataURL("image/"+t.saveAs,1)),i.toDataURL("image/"+t.saveAs,1)}}else if("Text"===this.watermark.type){var h,c,u=this.watermark.fontStyle&&this.watermark.fontStyle.font?this.watermark.fontStyle.font:"20px serif",l=this.watermark.fontStyle&&this.watermark.fontStyle.textAlign?this.watermark.fontStyle.textAlign:"start",f=this.watermark.fontStyle&&this.watermark.fontStyle.textBaseline?this.watermark.fontStyle.textBaseline:"alphabetic",m=this.watermark.fontStyle&&this.watermark.fontStyle.color?this.watermark.fontStyle.color:"#000000";if(n.font=u,n.textAlign=l,n.textBaseline=f,this.watermark.fontStyle&&this.watermark.fontStyle.rotate)h=this.watermark.fontStyle&&this.watermark.fontStyle.width?this.watermark.x+Math.floor(this.watermark.fontStyle.width/2):this.watermark.x,c=this.watermark.fontStyle&&this.watermark.fontStyle.lineHeight?this.watermark.y+Math.floor(this.watermark.fontStyle.lineHeight/2):this.watermark.y,n.translate(h,c),n.rotate(this.watermark.fontStyle.rotate*Math.PI/180),n.translate(-1*h,-1*c);return this.watermark.fontStyle&&this.watermark.fontStyle.drawType&&"stroke"===this.watermark.fontStyle.drawType?(n.strokeStyle=this.watermark.fontStyle.color,this.watermark.fontStyle&&this.watermark.fontStyle.width?this.wrapText(n,this.watermark.source,this.watermark.x,this.watermark.y,this.watermark.fontStyle.width,this.watermark.fontStyle.lineHeight):n.strokeText(this.watermark.source,this.watermark.x,this.watermark.y)):(n.fillStyle=m,this.watermark.fontStyle&&this.watermark.fontStyle.width?this.wrapText(n,this.watermark.source,this.watermark.x,this.watermark.y,this.watermark.fontStyle.width,this.watermark.fontStyle.lineHeight):n.fillText(this.watermark.source,this.watermark.x,this.watermark.y)),this.$emit("update:image",i.toDataURL("image/"+this.saveAs,1)),i.toDataURL("image/"+this.saveAs,1)}},isEmpty:function(){return!(this.images.length>0)},getAllStrokes:function(){return this.images}},render:function(){var e=this;return t.isVue2?t.h("canvas",r({attrs:{id:this.canvasId,width:this.width,height:this.height},style:r({touchAction:"none"},this.styles),class:this.classes,on:{mousedown:function(t){return e.startDraw(t)},mousemove:function(t){return e.draw(t)},mouseup:function(t){return e.stopDraw(t)},mouseleave:function(t){return e.stopDraw(t)},touchstart:function(t){return e.startDraw(t)},touchmove:function(t){return e.draw(t)},touchend:function(t){return e.stopDraw(t)},touchleave:function(t){return e.stopDraw(t)},touchcancel:function(t){return e.stopDraw(t)}}},this.$props)):t.h("canvas",{id:this.canvasId,height:this.height,width:this.width,style:r({touchAction:"none"},this.styles),class:this.classes,onMousedown:function(t){return e.startDraw(t)},onMousemove:function(t){return e.draw(t)},onMouseup:function(t){return e.stopDraw(t)},onMouseleave:function(t){return e.stopDraw(t)},onTouchstart:function(t){return e.startDraw(t)},onTouchmove:function(t){return e.draw(t)},onTouchend:function(t){return e.stopDraw(t)},onTouchleave:function(t){return e.stopDraw(t)},onTouchcancel:function(t){return e.stopDraw(t)}})}})}(VueDemi);